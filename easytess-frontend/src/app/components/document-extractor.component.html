<!-- document-extractor.component.html -->
<div class="extractor-container">
    <!-- â”€â”€â”€ Mode Selector â”€â”€â”€ -->
    <div class="mode-selector">
        <button class="mode-btn" [class.active]="activeMode() === 'unified'" (click)="setMode('unified')">
            <span class="mode-icon">ğŸ“„</span>
            <span class="mode-info">
                <span class="mode-title">Extraction UnifiÃ©e</span>
                <span class="mode-desc">PDF ou Word â†’ contenu structurÃ©</span>
            </span>
        </button>
        <button class="mode-btn" [class.active]="activeMode() === 'pdf'" (click)="setMode('pdf')">
            <span class="mode-icon">ğŸ“Š</span>
            <span class="mode-info">
                <span class="mode-title">Extraction PDF</span>
                <span class="mode-desc">Texte + tableaux depuis un PDF</span>
            </span>
        </button>
        <button class="mode-btn" [class.active]="activeMode() === 'convert'" (click)="setMode('convert')">
            <span class="mode-icon">ğŸ”„</span>
            <span class="mode-info">
                <span class="mode-title">PDF â†’ Word</span>
                <span class="mode-desc">Convertir un PDF en .docx</span>
            </span>
        </button>
    </div>

    <!-- â”€â”€â”€ Dropzone â”€â”€â”€ -->
    <div class="dropzone" [class.drag-over]="dragOver()" [class.has-file]="selectedFile()"
        (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">

        @if (!selectedFile()) {
        <div class="dropzone-content">
            <div class="dropzone-icon">
                @if (activeMode() === 'convert') { ğŸ”„ }
                @else if (activeMode() === 'pdf') { ğŸ“Š }
                @else { ğŸ“„ }
            </div>
            <p class="dropzone-text">Glissez-dÃ©posez votre fichier ici</p>
            <p class="dropzone-hint">ou</p>
            <label class="browse-btn" for="file-input-doc">
                Parcourir
            </label>
            <input type="file" id="file-input-doc" [accept]="acceptedFormats()" (change)="onFileSelected($event)"
                hidden />
            <p class="dropzone-formats">Formats: {{ acceptedFormats() }}</p>
        </div>
        } @else {
        <div class="file-preview">
            <div class="file-icon-large">
                @if (fileInfo()?.isPdf) { ğŸ“• }
                @else { ğŸ“˜ }
            </div>
            <div class="file-details">
                <span class="file-name">{{ fileInfo()?.name }}</span>
                <span class="file-meta">
                    <span class="file-badge" [class.pdf]="fileInfo()?.isPdf" [class.docx]="fileInfo()?.isDocx">
                        {{ fileInfo()?.ext?.toUpperCase() }}
                    </span>
                    {{ fileInfo()?.size }}
                </span>
            </div>
            <button class="remove-btn" (click)="removeFile()" title="Retirer">âœ•</button>
        </div>
        }
    </div>

    <!-- â”€â”€â”€ Options Panel â”€â”€â”€ -->
    @if (selectedFile()) {
    <div class="options-panel">
        <h3 class="options-title">âš™ï¸ Options</h3>

        <div class="options-grid">
            <!-- Strategy (PDF only) -->
            @if (fileInfo()?.isPdf) {
            <div class="option-group">
                <label class="option-label">StratÃ©gie de dÃ©tection</label>
                <select class="option-select" [ngModel]="strategy()" (ngModelChange)="strategy.set($event)">
                    <option value="auto">Auto (recommandÃ©)</option>
                    <option value="standard">Standard â€” bordures visibles</option>
                    <option value="text">Texte â€” tableaux sans bordures</option>
                    <option value="lines_strict">Strict â€” lignes nettes uniquement</option>
                </select>
            </div>

            <!-- Pages filter -->
            <div class="option-group">
                <label class="option-label">Pages Ã  extraire</label>
                <input class="option-input" type="text" placeholder="Toutes â€” ex: 1,3,5 ou 1-5"
                    [ngModel]="pagesFilter()" (ngModelChange)="pagesFilter.set($event)" />
            </div>
            }

            <!-- Columns filter -->
            <div class="option-group">
                <label class="option-label">Colonnes (tableaux)</label>
                <input class="option-input" type="text" placeholder="Toutes â€” ex: 0,1,3" [ngModel]="columnsFilter()"
                    (ngModelChange)="columnsFilter.set($event)" />
            </div>
        </div>

        <!-- Action buttons -->
        <div class="action-buttons">
            @if (activeMode() !== 'convert') {
            <button class="btn btn-primary" (click)="extract()" [disabled]="loading()">
                @if (loading()) {
                <span class="spinner"></span> Extraction...
                } @else {
                ğŸ“¥ Extraire le contenu
                }
            </button>
            }

            @if (activeMode() === 'convert' || (activeMode() === 'unified' && fileInfo()?.isPdf)) {
            <button class="btn btn-convert" (click)="convertToDocx()" [disabled]="converting()">
                @if (converting()) {
                <span class="spinner"></span> Conversion...
                } @else {
                ğŸ”„ Convertir en Word
                }
            </button>
            }
        </div>

        @if (convertSuccess()) {
        <div class="success-toast">
            âœ… Conversion rÃ©ussie ! Fichier Word tÃ©lÃ©chargÃ©.
        </div>
        }
    </div>
    }

    <!-- â”€â”€â”€ Error â”€â”€â”€ -->
    @if (error()) {
    <div class="error-banner">
        <span class="error-icon">âš ï¸</span>
        <span>{{ error() }}</span>
        <button class="error-close" (click)="error.set(null)">âœ•</button>
    </div>
    }

    <!-- â”€â”€â”€ Results â”€â”€â”€ -->
    @if (hasResults()) {
    <div class="results-container">
        <!-- Stats bar -->
        <div class="results-header">
            <h3>ğŸ“‹ RÃ©sultats â€” {{ resultFilename() }}</h3>
            <div class="results-stats">
                @if (resultFormat()) {
                <span class="stat-badge format">{{ resultFormat()?.toUpperCase() }}</span>
                }
                <span class="stat-badge text">ğŸ“ {{ textBlocs().length }} texte(s)</span>
                <span class="stat-badge table">ğŸ“Š {{ tableBlocs().length }} tableau(x)</span>
                @if (stats()) {
                <span class="stat-badge pages">ğŸ“„ {{ stats()!.pages_traitees }} page(s)</span>
                <span class="stat-badge strategy">ğŸ¯ {{ stats()!.strategie_utilisee }}</span>
                }
            </div>
            <div class="results-actions">
                <button class="btn btn-sm btn-json" (click)="exportJson()">
                    ğŸ’¾ Export JSON
                </button>
                <button class="btn btn-sm btn-preview" (click)="toggleJsonPreview()">
                    {{ showJsonPreview() ? 'ğŸ“‹ Masquer JSON' : 'ğŸ‘ï¸ AperÃ§u JSON' }}
                </button>
            </div>
        </div>

        <!-- JSON Preview -->
        @if (showJsonPreview()) {
        <div class="json-preview">
            <pre>{{ getJsonPreview() }}</pre>
        </div>
        }

        <!-- Content blocks -->
        <div class="blocks-list">
            @for (bloc of extractedContent(); track $index) {
            <div class="block-card" [class.text-block]="bloc.type === 'texte'"
                [class.table-block]="bloc.type === 'tableau'">

                @if (bloc.type === 'texte') {
                <div class="block-header text-header">
                    <span class="block-badge text-badge">ğŸ“ Texte</span>
                    @if (bloc.page) {
                    <span class="page-num">p.{{ bloc.page }}</span>
                    }
                </div>
                <div class="block-body text-body">
                    <p>{{ bloc.contenu }}</p>
                </div>
                }

                @if (bloc.type === 'tableau') {
                <div class="block-header table-header" (click)="toggleTable($index)">
                    <div class="table-title-row">
                        <span class="block-badge table-badge">ğŸ“Š Tableau #{{ bloc.numero }}</span>
                        @if (bloc.metadata) {
                        <span class="table-dims">
                            {{ bloc.metadata.nb_lignes }} Ã— {{ bloc.metadata.nb_colonnes }}
                        </span>
                        @if (bloc.metadata.a_entete) {
                        <span class="header-badge">En-tÃªte dÃ©tectÃ©</span>
                        }
                        }
                        @if (bloc.page) {
                        <span class="page-num">p.{{ bloc.page }}</span>
                        }
                    </div>
                    <span class="expand-icon">{{ isTableExpanded($index) ? 'â–¼' : 'â–¶' }}</span>
                </div>

                @if (isTableExpanded($index) && bloc.lignes) {
                <div class="block-body table-body">
                    <div class="table-scroll">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th class="row-num">#</th>
                                    @for (key of getTableKeys(bloc); track key) {
                                    <th>{{ getFormatLabel(key) }}</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @for (row of bloc.lignes; track $index) {
                                <tr>
                                    <td class="row-num">{{ $index + 1 }}</td>
                                    @for (key of getTableKeys(bloc); track key) {
                                    <td>{{ row[key] || '' }}</td>
                                    }
                                </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                }
                }
            </div>
            }
        </div>
    </div>
    }
</div>