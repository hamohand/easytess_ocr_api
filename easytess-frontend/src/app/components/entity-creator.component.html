<!-- entity-creator.component.html -->
<div class="entity-creator">
    <div class="header">
        <h1>üé® Gestion des Entit√©s OCR</h1>
        <p>Cr√©ez et g√©rez vos mod√®les de zones OCR</p>
    </div>

    <!-- Messages -->
    @if (errorMessage()) {
    <div class="error-message">
        ‚ö†Ô∏è {{ errorMessage() }}
    </div>
    }

    @if (successMessage()) {
    <div class="success-message">
        {{ successMessage() }}
    </div>
    }

    <!-- ==================== LISTE DES ENTIT√âS EXISTANTES ==================== -->
    <div class="entities-section">
        <div class="section-header">
            <h2>üìÇ Entit√©s existantes</h2>
            <button class="btn btn-small btn-outline" (click)="chargerEntites()" [disabled]="isLoadingEntites()">
                üîÑ Rafra√Æchir
            </button>
        </div>

        @if (isLoadingEntites()) {
        <div class="loading">Chargement...</div>
        } @else if (entites().length === 0) {
        <div class="empty-state">
            <p>Aucune entit√© cr√©√©e. Utilisez le formulaire ci-dessous pour en cr√©er une.</p>
        </div>
        } @else {
        <div class="entities-grid">
            @for (entite of entites(); track entite.nom) {
            <div class="entity-card" [class.editing]="editingEntityName() === entite.nom">
                <div class="entity-info">
                    <h4>{{ entite.nom }}</h4>
                    <p class="entity-desc">{{ entite.description || 'Aucune description' }}</p>
                    <span class="zones-count">{{ entite.zones.length }} zone(s)</span>
                </div>
                <div class="entity-actions">
                    <button class="btn btn-small btn-primary" (click)="chargerEntite(entite.nom)" title="Modifier">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn btn-small btn-danger" (click)="supprimerEntite(entite.nom)" title="Supprimer">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
            }
        </div>
        }
    </div>

    <!-- ==================== FORMULAIRE DE CR√âATION/√âDITION ==================== -->
    <div class="creator-section">
        <div class="section-header">
            @if (editMode()) {
            <h2>‚úèÔ∏è Modifier l'entit√©: {{ editingEntityName() }}</h2>
            } @else {
            <h2>‚ûï Cr√©er une nouvelle entit√©</h2>
            }
        </div>

        <!-- Entity Info Form -->
        <div class="entity-form">
            <div class="form-group">
                <label for="entityName">Nom de l'entit√© *</label>
                <input type="text" id="entityName" [(ngModel)]="entityName"
                    placeholder="Ex: Facture EDF, Carte d'identit√©..." [value]="entityName()" [disabled]="editMode()">
            </div>

            <div class="form-group">
                <label for="entityDesc">Description</label>
                <textarea id="entityDesc" [(ngModel)]="entityDescription" [value]="entityDescription()"
                    placeholder="Description optionnelle de l'entit√©..." rows="2"></textarea>
            </div>
        </div>

        <!-- Image Upload -->
        <div class="upload-section">
            <input type="file" #imageInput accept="image/*,application/pdf" (change)="onImageSelected($event)"
                style="display: none">
            <button class="btn btn-primary" (click)="imageInput.click()">
                üìÅ Choisir une image de r√©f√©rence
            </button>
            @if (uploadedImageFilename()) {
            <span class="filename">{{ uploadedImageFilename() }}</span>
            }
        </div>

        <!-- Canvas Drawing Area -->
        @if (imageUrl()) {
        <div class="canvas-section">
            <div class="canvas-controls">
                <div class="zone-name-input">
                    <label for="zoneName">Nom de la prochaine zone :</label>
                    <input type="text" id="zoneName" [(ngModel)]="currentZoneName" [value]="currentZoneName()"
                        placeholder="Ex: Date, Montant, Nom...">
                </div>
                <div class="instructions">
                    üí° Cliquez et glissez sur l'image pour dessiner une zone
                </div>
            </div>

            <div class="canvas-wrapper">
                <canvas #canvas (mousedown)="onMouseDown($event)" (mousemove)="onMouseMove($event)"
                    (mouseup)="onMouseUp($event)" [class.drawing]="isDrawing()">
                </canvas>
            </div>
        </div>

        <!-- NOUVEAU: Section Cadre de R√©f√©rence (3 √©tiquettes) -->
        <div class="anchors-section">
            <h3>üìê Cadre de R√©f√©rence</h3>
            <p class="section-help">
                D√©finissez 3 √©tiquettes pour cr√©er un syst√®me de coordonn√©es stable.<br>
                <strong>Texte:</strong> PASSPORT, PASSEPORT (s√©par√©s par virgule)<br>
                <strong>Regex:</strong> <code>regex:\d&#123;9&#125;</code> (9 chiffres cons√©cutifs)
            </p>

            <div class="cadre-labels">
                <!-- √âtiquette HAUT (Y min) -->
                <div class="cadre-label-item ref-haut">
                    <div class="label-header">
                        <span class="label-icon">üîº</span>
                        <span class="label-title">HAUT</span>
                        <span class="label-hint">(d√©finit la limite haute)</span>
                    </div>
                    <div class="input-with-action">
                        <input type="text" [ngModel]="cadreHaut().labels_str"
                            (ngModelChange)="cadreHaut.set({labels_str: $event, position_base: cadreHaut().position_base})"
                            placeholder="Ex: R√âPUBLIQUE ALG√âRIENNE" class="cadre-input">
                        <button type="button" class="btn-target" [class.active]="activeReferenceSelection() === 'haut'"
                            (click)="startReferenceSelection('haut')"
                            title="Cliquer pour d√©finir la position sur l'image">
                            üìç
                        </button>
                    </div>
                    <div class="coords-display">
                        Pos: [ {{cadreHaut().position_base[0] | number:'1.3-3'}}, {{cadreHaut().position_base[1] |
                        number:'1.3-3'}} ]
                    </div>
                </div>

                <!-- √âtiquette DROITE (X max) -->
                <div class="cadre-label-item ref-droite">
                    <div class="label-header">
                        <span class="label-icon">‚è©</span>
                        <span class="label-title">DROITE</span>
                        <span class="label-hint">(d√©finit la limite droite)</span>
                    </div>
                    <div class="input-with-action">
                        <input type="text" [ngModel]="cadreDroite().labels_str"
                            (ngModelChange)="cadreDroite.set({labels_str: $event, position_base: cadreDroite().position_base})"
                            placeholder="Ex: P<DZA (texte √† droite)" class="cadre-input">
                        <button type="button" class="btn-target"
                            [class.active]="activeReferenceSelection() === 'droite'"
                            (click)="startReferenceSelection('droite')"
                            title="Cliquer pour d√©finir la position sur l'image">
                            üìç
                        </button>
                    </div>
                    <div class="coords-display">
                        Pos: [ {{cadreDroite().position_base[0] | number:'1.3-3'}}, {{cadreDroite().position_base[1] |
                        number:'1.3-3'}} ]
                    </div>
                </div>

                <!-- √âtiquette GAUCHE-BAS (X min, Y max) -->
                <div class="cadre-label-item ref-gauche-bas">
                    <div class="label-header">
                        <span class="label-icon">‚ÜôÔ∏è</span>
                        <span class="label-title">GAUCHE-BAS</span>
                        <span class="label-hint">(d√©finit origines X et Y)</span>
                    </div>
                    <div class="input-with-action">
                        <input type="text" [ngModel]="cadreGaucheBas().labels_str"
                            (ngModelChange)="cadreGaucheBas.set({labels_str: $event, position_base: cadreGaucheBas().position_base})"
                            placeholder="Ex: SIGNATURE (texte en bas √† gauche)" class="cadre-input">
                        <button type="button" class="btn-target"
                            [class.active]="activeReferenceSelection() === 'gauche_bas'"
                            (click)="startReferenceSelection('gauche_bas')"
                            title="Cliquer pour d√©finir la position sur l'image">
                            üìç
                        </button>
                    </div>
                    <div class="coords-display">
                        Pos: [ {{cadreGaucheBas().position_base[0] | number:'1.3-3'}},
                        {{cadreGaucheBas().position_base[1] |
                        number:'1.3-3'}} ]
                    </div>
                </div>
            </div>

            <!-- Bouton de d√©tection automatique -->
            <div class="detection-actions">
                <button type="button" class="btn-detect" (click)="detecterEtiquettes()"
                    [disabled]="isDetecting() || !uploadedImageFilename()">
                    @if (isDetecting()) {
                    ‚è≥ D√©tection en cours...
                    } @else {
                    üîç D√©tecter automatiquement
                    }
                </button>
                <p class="detection-help">
                    Cliquez pour d√©tecter automatiquement les positions des √©tiquettes via OCR.
                </p>
            </div>

            <!-- Indicateur de validit√© -->
            @if (isCadreValide()) {
            <div class="anchors-info success">
                ‚úÖ Cadre de r√©f√©rence complet. Les zones seront d√©finies par rapport √† ce cadre.
            </div>
            } @else {
            <div class="anchors-info warning">
                ‚ö†Ô∏è Remplissez les 3 √©tiquettes puis cliquez sur "D√©tecter automatiquement".
            </div>
            }

            <!-- Affichage des param√®tres calcul√©s -->
            @if (cadreParams()) {
            <div class="reference-params">
                <h4>üìè Param√®tres du cadre de r√©f√©rence</h4>
                <div class="params-grid">
                    <div class="param-item">
                        <span class="param-label">Largeur:</span>
                        <span class="param-value">{{ cadreParams()?.largeur }}% ({{ cadreParams()?.largeur_px
                            }}px)</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">Hauteur:</span>
                        <span class="param-value">{{ cadreParams()?.hauteur }}% ({{ cadreParams()?.hauteur_px
                            }}px)</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">Angle:</span>
                        <span class="param-value">{{ cadreParams()?.angle }}¬∞</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">Origine (X, Y):</span>
                        <span class="param-value">[{{ cadreParams()?.x_min | number:'1.3-3' }}, {{ cadreParams()?.y_min
                            | number:'1.3-3' }}]</span>
                    </div>
                </div>
            </div>
            }
        </div>

        <!-- Zones List -->
        @if (zones().length > 0) {
        <div class="zones-list">
            <h3>üìã Zones d√©finies ({{ zones().length }})</h3>
            
            <!-- NOUVEAU: Indicateur de syst√®me de coordonn√©es -->
            <div class="coordinate-info">
                @if (isCadreValide()) {
                    <div class="info-box info-primary">
                        üìê <strong>Coordonn√©es relatives √† l'image</strong>
                        <p class="info-detail">Les coordonn√©es affich√©es sont relatives √† l'image compl√®te (0-1). 
                        √Ä la sauvegarde, elles seront converties en coordonn√©es relatives au cadre de r√©f√©rence.</p>
                    </div>
                } @else {
                    <div class="info-box info-warning">
                        ‚ö†Ô∏è <strong>Aucun cadre de r√©f√©rence</strong>
                        <p class="info-detail">Les coordonn√©es sont relatives √† l'image compl√®te. 
                        D√©finissez un cadre de r√©f√©rence pour plus de robustesse.</p>
                    </div>
                }
            </div>
            
            <div class="zones-grid">
                @for (zone of zones(); track zone.id) {
                <div class="zone-card">
                    <div class="zone-header">
                        <span class="zone-number">{{ $index + 1 }}</span>
                        <input type="text" [(ngModel)]="zone.nom" class="zone-name-edit" placeholder="Nom de la zone"
                            (ngModelChange)="onZoneChanged()">
                    </div>

                    <!-- Coordonn√©es √©ditables (format relatif 0.0-1.0) -->
                    <div class="zone-coords-edit">
                        <div class="coords-row">
                            <label>X1:</label>
                            <input type="number" [(ngModel)]="zone.coords[0]" class="coord-input" step="0.01" min="0"
                                max="1" (ngModelChange)="onZoneChanged()">
                            <label>Y1:</label>
                            <input type="number" [(ngModel)]="zone.coords[1]" class="coord-input" step="0.01" min="0"
                                max="1" (ngModelChange)="onZoneChanged()">
                        </div>
                        <div class="coords-row">
                            <label>X2:</label>
                            <input type="number" [(ngModel)]="zone.coords[2]" class="coord-input" step="0.01" min="0"
                                max="1" (ngModelChange)="onZoneChanged()">
                            <label>Y2:</label>
                            <input type="number" [(ngModel)]="zone.coords[3]" class="coord-input" step="0.01" min="0"
                                max="1" (ngModelChange)="onZoneChanged()">
                        </div>
                    </div>

                    <!-- Config Zone -->
                    <div class="zone-config">
                        <div class="config-row">
                            <label>Type:</label>
                            <select [(ngModel)]="zone.type" class="sm-input">
                                <option value="text">Texte OCR</option>
                                <option value="qrcode">QR Code</option>
                                <option value="barcode">Code Barre</option>
                            </select>
                        </div>

                        @if (!zone.type || zone.type === 'text') {
                        <div class="config-row">
                            <label>Langue OCR:</label>
                            <select [(ngModel)]="zone.lang" class="sm-input">
                                <option value="ara+fra">Arabe + Fran√ßais</option>
                                <option value="fra">Fran√ßais seul</option>
                                <option value="ara">Arabe seul</option>
                                <option value="eng">Anglais</option>
                            </select>
                        </div>

                        <div class="config-row">
                            <label title="Mode de pr√©traitement d'image">Pr√©traitement:</label>
                            <select [(ngModel)]="zone.preprocess" class="sm-input">
                                <option value="auto">Auto (selon langue)</option>
                                <option value="arabic_textured">Arabe textur√©</option>
                                <option value="latin_simple">Latin simple</option>
                                <option value="none">Aucun</option>
                            </select>
                        </div>

                        <div class="config-row">
                            <label title="Valeurs possibles s√©par√©es par des virgules">Valeurs attendues:</label>
                            <input type="text" [(ngModel)]="zone.valeurs_str" placeholder="Ex: M, F (optionnel)"
                                class="sm-input full-width">
                        </div>
                        }
                    </div>

                    <button class="btn-delete" (click)="deleteZone(zone.id)" title="Supprimer">
                        üóëÔ∏è
                    </button>
                </div>
                }
            </div>
        </div>
        }

        <!-- Save Button -->
        <div class="save-section">
            <button class="btn btn-success" (click)="saveEntity()"
                [disabled]="isSaving() || zones().length === 0 || !entityName()">
                @if (isSaving()) {
                <span class="spinner"></span> Sauvegarde...
                } @else if (editMode()) {
                üíæ Mettre √† jour l'entit√©
                } @else {
                üíæ Sauvegarder l'entit√©
                }
            </button>
            @if (editMode()) {
            <button class="btn btn-outline" (click)="cancelEdit()">
                ‚ùå Annuler
            </button>
            } @else {
            <button class="btn btn-outline" (click)="reset()">
                üîÑ R√©initialiser
            </button>
            }
        </div>
        }
    </div>
</div>